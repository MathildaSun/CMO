name: CI/CD
on:
  push:

branches: [ main ]

pull_request:

branches: [ main ]

workflowdispatch:
permissions:
  contents: read
  packages: write
env:
  REGISTRY: ghcr.io
  IMAGENAME: ${{ github.repository }}
jobs:
  build-test:

runs-on: ubuntu-latest
steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: npm
  - name: Install deps
    run: npm ci
  - name: Lint
    run: npm run lint
  - name: Typecheck
    run: npm run typecheck
  - name: Test
    run: npm test

docker-publish:

needs: build-test
runs-on: ubuntu-latest
if: github.event_name == 'push'
steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Login to GHCR
    uses: docker/login-action@v3
    with:
      registry: ${{ env.REGISTRY }}
      username: ${{ github.actor }}
      password: ${{ secrets.GITHUB_TOKEN }}
  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v3
  - name: Build and push
    uses: docker/build-push-action@v6
    with:
      context: .
      push: true
      tags: |
        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

deploy-railway:

needs: docker-publish
runs-on: ubuntu-latest
if: github.event_name == 'push' && secrets.RAILWAY_TOKEN != ''
steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: 20
  - name: Install Railway CLI
    run: npm i -g @railway/cli
  - name: Deploy to Railway
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
    run: |
      if [ -n "$RAILWAY_PROJECT_ID" ]; then
        railway link --project "$RAILWAY_PROJECT_ID"
      fi
      if [ -n "$RAILWAY_SERVICE_NAME" ]; then
        railway up --service "$RAILWAY_SERVICE_NAME" --ci
      else
        railway up --ci
      fi

smoke:

needs: [docker-publish]
runs-on: ubuntu-latest
if: github.event_name == 'push' && vars.STAGING_BASE_URL != ''
steps:
  - name: Checkout
    uses: actions/checkout@v4
  - name: Setup Node
    uses: actions/setup-node@v4
    with:
      node-version: 20
  - name: Install deps
    run: npm ci
  - name: Run smoke tests
    env:
      BASE_URL: ${{ vars.STAGING_BASE_URL }}
      SMOKE_SEND_SLACK: 0
      SMOKE_CHECK_LATE: 0
      SMOKE_CHECK_FAL: 0
      API_BEARER_TOKEN: ${{ secrets.API_BEARER_TOKEN }}
    run: npm run smoke

